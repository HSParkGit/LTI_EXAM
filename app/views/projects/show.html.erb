<div class="project-show-container">
  <div class="project-header">
    <div class="project-header-content">
      <h1><%= @project_data[:name] %></h1>
      <div class="project-header-actions">
        <%= link_to '← 목록으로', projects_path, class: 'btn-back' %>
        <%= link_to '수정', edit_project_path(@project), class: 'btn-edit' %>
        <%= button_to '삭제', project_path(@project), 
            method: :delete, 
            data: { confirm: '정말 삭제하시겠습니까?', turbo: false }, 
            class: 'btn-delete',
            form: { style: 'display: inline;' } %>
      </div>
    </div>
  </div>
  
  <% if flash[:notice] %>
    <div class="alert alert-success"><%= flash[:notice] %></div>
  <% end %>
  
  <% if flash[:error] %>
    <div class="alert alert-danger"><%= flash[:error] %></div>
  <% end %>
  
  <!-- STEP 목록 -->
  <% if @project_data[:assignments].present? && @project_data[:assignments].any? %>
    <div class="steps-container">
      <% @project_data[:assignments].each_with_index do |assignment, index| %>
        <% step_status = get_step_status(assignment) %>
        <div class="step-card step-<%= step_status %>">
          <!-- Step Header -->
          <div class="step-header">
            <div class="step-title-section">
              <h2 class="step-title">
                <%= assignment['name'] || "STEP #{index + 1}" %>
              </h2>
              <span class="step-badge badge-<%= step_status %>">
                <%= case step_status
                    when 'past' then 'Past'
                    when 'current' then 'Current'
                    when 'upcoming' then 'Upcoming'
                    else 'Empty'
                    end %>
              </span>
            </div>
            <div class="step-actions">
              <% if @canvas_url.present? && @lti_context.canvas_course_id.present? %>
                <%= link_to 'Canvas에서 보기', 
                    canvas_assignment_url(@lti_context.canvas_course_id, assignment['id'], @canvas_url),
                    target: '_blank',
                    class: 'btn-link' %>
              <% end %>
            </div>
          </div>
          
          <!-- Step Description -->
          <% if assignment['description'].present? %>
            <div class="step-description">
              <%= simple_format(assignment['description']) %>
            </div>
          <% end %>
          
          <!-- Step Details -->
          <div class="step-details">
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">Available from</span>
                <span class="detail-value">
                  <%= assignment['unlock_at'].present? ? format_date(assignment['unlock_at']) : '-' %>
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Due Date</span>
                <span class="detail-value">
                  <%= assignment['due_at'].present? ? format_date(assignment['due_at']) : '-' %>
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Until</span>
                <span class="detail-value">
                  <%= assignment['lock_at'].present? ? format_date(assignment['lock_at']) : '-' %>
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Points</span>
                <span class="detail-value">
                  <%= assignment['points_possible'] || 0 %>점
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Status</span>
                <span class="detail-value">
                  <span class="badge <%= assignment['workflow_state'] == 'published' ? 'badge-published' : 'badge-unpublished' %>">
                    <%= assignment['workflow_state'] == 'published' ? 'Published' : 'Unpublished' %>
                  </span>
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Submission Types</span>
                <span class="detail-value">
                  <%= Array(assignment['submission_types']).join(', ') || '-' %>
                </span>
              </div>
            </div>
          </div>
          
          <!-- Instructor Statistics -->
          <% if @user_role == :instructor %>
            <div class="step-statistics">
              <h3 class="statistics-title">Submission Statistics</h3>
              <div class="statistics-grid">
                <div class="stat-card">
                  <div class="stat-number"><%= assignment['submitted_count'] || 0 %></div>
                  <div class="stat-label">Submitted</div>
                </div>
                <div class="stat-card">
                  <div class="stat-number"><%= assignment['unsubmitted_count'] || 0 %></div>
                  <div class="stat-label">Unsubmitted</div>
                </div>
                <div class="stat-card stat-card-success">
                  <div class="stat-number"><%= assignment['graded_count'] || 0 %></div>
                  <div class="stat-label">Graded</div>
                </div>
                <div class="stat-card stat-card-warning">
                  <div class="stat-number"><%= assignment['grading_required'] || 0 %></div>
                  <div class="stat-label">Needs Grading</div>
                </div>
              </div>
              
              <% if @canvas_url.present? && @lti_context.canvas_course_id.present? %>
                <div class="statistics-actions">
                  <%= link_to 'SpeedGrader에서 채점', 
                      speed_grader_url(@lti_context.canvas_course_id, assignment['id'], @canvas_url),
                      target: '_blank',
                      class: 'btn-primary' %>
                  <% if (assignment['grading_required'] || 0) > 0 %>
                    <span class="badge badge-needs-grading">
                      <%= assignment['grading_required'] %>건 채점 필요
                    </span>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% else %>
            <!-- Student Submission Status -->
            <div class="step-submission">
              <h3 class="submission-title">Your Submission</h3>
              <div class="submission-status">
                <% if assignment['is_submitted'] %>
                  <div class="submission-status-content">
                    <span class="badge badge-submitted">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="margin-right: 4px;">
                        <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      제출 완료
                    </span>
                    <% if @canvas_url.present? && @lti_context.canvas_course_id.present? %>
                      <%= link_to '제출물 보기', 
                          canvas_submission_url(@lti_context.canvas_course_id, assignment['id'], @lti_claims[:canvas_user_id] || @lti_claims["canvas_user_id"], @canvas_url),
                          target: '_blank',
                          class: 'btn-primary' %>
                    <% end %>
                  </div>
                <% else %>
                  <div class="submission-status-content">
                    <span class="badge badge-not-submitted">미제출</span>
                    <% if @canvas_url.present? && @lti_context.canvas_course_id.present? %>
                      <%= link_to '제출하기', 
                          canvas_assignment_url(@lti_context.canvas_course_id, assignment['id'], @canvas_url),
                          target: '_blank',
                          class: 'btn-primary' %>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="empty-state">
      <p>과제가 없습니다.</p>
    </div>
  <% end %>
</div>

<style>
  .project-show-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }
  
  .project-header {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e9ecef;
  }
  
  .project-header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .project-header h1 {
    font-size: 2rem;
    font-weight: 600;
    color: #212529;
    margin: 0;
  }
  
  .project-header-actions {
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }
  
  .btn-back {
    padding: 0.5rem 1rem;
    color: #6c757d;
    text-decoration: none;
    font-size: 0.875rem;
    transition: color 0.2s;
  }
  
  .btn-back:hover {
    color: #212529;
  }
  
  .btn-edit {
    padding: 0.5rem 1.25rem;
    background-color: #0626a9;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
    transition: background-color 0.2s;
  }
  
  .btn-edit:hover {
    background-color: #051d8a;
    color: white;
  }
  
  .btn-delete {
    padding: 0.5rem 1.25rem;
    background-color: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .btn-delete:hover {
    background-color: #bb2d3b;
  }
  
  .steps-container {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }
  
  .step-card {
    background-color: white;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: box-shadow 0.2s;
  }
  
  .step-card:hover {
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  
  .step-card.step-past {
    border-left: 4px solid #6c757d;
    background-color: #f8f9fa;
  }
  
  .step-card.step-current {
    border-left: 4px solid #0626a9;
    background-color: #f0f4ff;
  }
  
  .step-card.step-upcoming {
    border-left: 4px solid #ffc107;
    background-color: #fffbf0;
  }
  
  .step-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
  }
  
  .step-title-section {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .step-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #212529;
    margin: 0;
  }
  
  .step-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
  }
  
  .badge-past {
    background-color: #e9ecef;
    color: #495057;
  }
  
  .badge-current {
    background-color: #cfe2ff;
    color: #084298;
  }
  
  .badge-upcoming {
    background-color: #fff3cd;
    color: #856404;
  }
  
  .step-actions {
    display: flex;
    gap: 0.5rem;
  }
  
  .btn-link {
    color: #0626a9;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .btn-link:hover {
    text-decoration: underline;
  }
  
  .step-description {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 8px;
    color: #495057;
    line-height: 1.6;
  }
  
  .step-details {
    margin-bottom: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e9ecef;
  }
  
  .detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
  }
  
  .detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .detail-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #6c757d;
  }
  
  .detail-value {
    font-size: 1rem;
    color: #212529;
    font-weight: 500;
  }
  
  .badge {
    display: inline-block;
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 600;
  }
  
  .badge-published {
    background-color: #d1e7dd;
    color: #0f5132;
  }
  
  .badge-unpublished {
    background-color: #fff3cd;
    color: #856404;
  }
  
  .step-statistics {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e9ecef;
  }
  
  .statistics-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #212529;
    margin-bottom: 1rem;
  }
  
  .statistics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .stat-card {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    border: 1px solid #e9ecef;
  }
  
  .stat-card-success {
    background-color: #d1e7dd;
    border-color: #badbcc;
  }
  
  .stat-card-warning {
    background-color: #fff3cd;
    border-color: #ffc107;
  }
  
  .stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: #212529;
    margin-bottom: 0.5rem;
  }
  
  .stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
  }
  
  .statistics-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .btn-primary {
    padding: 0.625rem 1.25rem;
    background-color: #0626a9;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
    transition: background-color 0.2s;
    display: inline-block;
  }
  
  .btn-primary:hover {
    background-color: #051d8a;
    color: white;
  }
  
  .badge-needs-grading {
    background-color: #fff3cd;
    color: #856404;
  }
  
  .step-submission {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e9ecef;
  }
  
  .submission-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: #212529;
    margin-bottom: 1rem;
  }
  
  .submission-status {
    display: flex;
    align-items: center;
  }
  
  .submission-status-content {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  
  .badge-submitted {
    background-color: #d1e7dd;
    color: #0f5132;
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 0.75rem;
  }
  
  .badge-not-submitted {
    background-color: #fff3cd;
    color: #856404;
  }
  
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #6c757d;
  }
  
  .alert {
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
    margin-bottom: 1.5rem;
  }
  
  .alert-success {
    background-color: #d1e7dd;
    color: #0f5132;
    border: 1px solid #badbcc;
  }
  
  .alert-danger {
    background-color: #f8d7da;
    color: #842029;
    border: 1px solid #f5c2c7;
  }
</style>
