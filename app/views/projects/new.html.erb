<div class="project-form-container">
  <div class="form-header">
    <h1>Add Project</h1>
  </div>
  
  <% if flash[:error] %>
    <div class="alert alert-danger"><%= flash[:error] %></div>
  <% end %>
  
  <%= form_with model: @project, url: projects_path, local: true, html: { id: 'project-form' } do |form| %>
    <!-- Project Form Card -->
    <div class="form-card">
      <!-- Project Title -->
      <div class="form-row">
        <div class="form-column-left">
          <label>Project Title</label>
        </div>
        <div class="form-column-right">
          <%= form.text_field :name, 
              class: 'input-full', 
              placeholder: 'Project Title',
              required: true,
              id: 'project_title' %>
        </div>
      </div>
      
      <!-- Group Assignment -->
      <div class="form-row">
        <div class="form-column-left">
          <label>Group Assignment</label>
        </div>
        <div class="form-column-right">
          <div class="border-box">
            <div class="checkbox-group">
              <label class="checkbox-label">
                <%= check_box_tag 'has_group_category', '1', true, id: 'has_group_category', disabled: true %>
                <span>This is a Group Assignment</span>
              </label>
            </div>
            <div class="checkbox-group" style="padding-left: 1.5rem;">
              <label class="checkbox-label">
                <%= form.check_box :grade_group_students_individually, id: 'assignment_grade_students_individually' %>
                <span>Assign Grades to Each Student Individually</span>
              </label>
            </div>
            <div class="form-group" style="margin-top: 1rem;">
              <label for="assignment_group_category_id">Group Set</label>
              <%= form.select :group_category_id, 
                  options_for_select(@group_categories.map { |gc| [gc['name'] || gc[:name], gc['id'] || gc[:id]] }, nil),
                  { include_blank: 'Select a group category' },
                  { class: 'form-select', id: 'assignment_group_category_id' } %>
            </div>
            <button type="button" class="btn-secondary" style="margin-top: 0.5rem;">
              New Group Category
            </button>
          </div>
        </div>
      </div>
      
      <!-- Assignment Group -->
      <div class="form-row">
        <div class="form-column-left">
          <label>Assignment Group</label>
        </div>
        <div class="form-column-right">
          <%= form.select :assignment_group_id, 
              options_for_select(@assignment_groups.map { |ag| [ag['name'] || ag[:name], ag['id'] || ag[:id]] }, nil),
              { include_blank: 'Select an assignment group' },
              { class: 'form-select', id: 'assignment_group_id' } %>
        </div>
      </div>
      
      <!-- Create Slack Channel -->
      <div class="form-row">
        <div class="form-column-left">
          <label>Create Slack Channel</label>
        </div>
        <div class="form-column-right">
          <div class="border-box">
            <label class="checkbox-label">
              <%= check_box_tag 'allow_slack_channel_creation', '1', false, id: 'allow-slack-channel-creation' %>
              <span>Agree to create a Slack channel for this project</span>
            </label>
          </div>
        </div>
      </div>
      
      <!-- Step Generator -->
      <div class="form-row">
        <div class="form-column-left">
          <label>Step Generator</label>
        </div>
        <div class="form-column-right">
          <div class="step-generator-wrapper">
            <button type="button" class="step-select-button" id="step-select-button">
              <div class="step-select-info">
                <span class="step-number" id="current-step-number">Step 1</span>
                <div class="step-date-preview" id="step-date-preview">
                  <span>Start yy/mm/dd --:-- - Due yy/mm/dd --:--</span>
                  <span>/ End yy/mm/dd --:--</span>
                </div>
              </div>
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" class="arrow-icon">
                <path d="M6 9L12 15L18 9" stroke="#0626a9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            
            <!-- Step Dropdown -->
            <div class="step-dropdown" id="step-dropdown" style="display: none;">
              <div id="step-list">
                <!-- Steps will be dynamically added here -->
              </div>
              <button type="button" class="new-step-button" id="add-step-button">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="10" stroke="#0626a9" stroke-width="2"/>
                  <path d="M12 8V16M8 12H16" stroke="#0626a9" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>New Step</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Step Detail Form Card -->
    <div class="form-card" id="step-detail-card">
      <div class="form-header">
        <h2 id="step-detail-title">Step 1</h2>
      </div>
      
      <div id="step-forms-container">
        <!-- Step forms will be dynamically added here -->
      </div>
      
      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn-cancel" onclick="window.location.href='<%= projects_path %>'">
          Cancel
        </button>
        <button type="submit" class="btn-primary" id="save-button">
          Save
        </button>
        <button type="button" class="btn-primary" id="save-publish-button">
          Save & Publish
        </button>
      </div>
    </div>
  <% end %>
</div>

<style>
  .project-form-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }
  
  .form-header {
    display: flex;
    align-items: center;
    padding: 20px 0;
  }
  
  .form-header h1 {
    font-size: 26px;
    font-weight: 500;
    margin: 0;
    margin-left: 20px;
    color: #212529;
  }
  
  .form-card {
    background-color: white;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 52px;
  }
  
  .form-row {
    display: flex;
    margin-bottom: 20px;
  }
  
  .form-column-left {
    min-width: 200px;
    width: 200px;
    font-size: 16px;
    font-weight: 500;
    color: #374151;
    line-height: 24px;
    margin-top: 4px;
    flex-shrink: 0;
  }
  
  .form-column-right {
    flex: 1;
    margin-top: 20px;
  }
  
  .input-full {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d0d1d7;
    border-radius: 4px;
    font-size: 14px;
  }
  
  .input-full:focus {
    outline: none;
    border-color: #0626a9;
  }
  
  .form-select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d0d1d7;
    border-radius: 4px;
    font-size: 14px;
    background-color: white;
  }
  
  .border-box {
    border: 1px solid #d0d1d7;
    border-radius: 4px;
    padding: 16px;
    background-color: #fafbfc;
  }
  
  .checkbox-group {
    margin-bottom: 12px;
  }
  
  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-size: 14px;
  }
  
  .checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }
  
  .form-group {
    margin-top: 1rem;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    font-size: 14px;
  }
  
  .btn-secondary {
    padding: 6px 12px;
    border: 1px solid #6b7280;
    border-radius: 4px;
    background-color: #efefef;
    color: #6b7280;
    cursor: pointer;
    font-size: 14px;
  }
  
  .btn-secondary:hover {
    background-color: #e5e7eb;
  }
  
  /* Step Generator Styles */
  .step-generator-wrapper {
    position: relative;
    width: 100%;
  }
  
  .step-select-button {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 12px;
    border: 1px solid #d0d1d7;
    border-radius: 4px;
    background-color: white;
    cursor: pointer;
    transition: border-color 0.2s ease;
  }
  
  .step-select-button:hover {
    border-color: #0626a9;
  }
  
  .step-select-info {
    display: flex;
    flex-grow: 1;
    align-items: center;
    margin-right: 20px;
    gap: 24px;
  }
  
  .step-number {
    font-size: 14px;
    font-weight: 500;
    color: #0626a9;
    flex: 1;
    text-align: left;
  }
  
  .step-date-preview {
    display: flex;
    font-size: 12px;
    color: #6b7280;
    white-space: nowrap;
  }
  
  .arrow-icon {
    transition: transform 0.2s ease;
  }
  
  .step-select-button.open .arrow-icon {
    transform: rotate(180deg);
  }
  
  .step-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    margin-top: 4px;
    background-color: white;
    border: 1px solid #d0d1d7;
    border-radius: 4px;
    padding: 16px 12px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    max-height: 400px;
    overflow-y: auto;
  }
  
  .step-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 8px 12px;
    border: none;
    background-color: transparent;
    cursor: pointer;
    transition: background-color 0.2s ease;
    border-radius: 4px;
  }
  
  .step-item:hover {
    background-color: #fafbfc;
  }
  
  .step-item.selected {
    background-color: #f0f4ff;
  }
  
  .step-item-content {
    display: flex;
    flex: 1;
    align-items: center;
    gap: 24px;
  }
  
  .step-item-info {
    display: flex;
    align-items: center;
    flex: 1;
    gap: 8px;
  }
  
  .step-item-number {
    font-size: 14px;
    font-weight: 500;
    color: #0626a9;
  }
  
  .step-item-date {
    font-size: 12px;
    color: #6b7280;
    white-space: nowrap;
  }
  
  .delete-step-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    border: none;
    background-color: transparent;
    cursor: pointer;
    padding: 0;
    flex-shrink: 0;
  }
  
  .new-step-button {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    padding: 6px 12px;
    border: 1px dashed #d0d1d7;
    border-radius: 4px;
    background-color: transparent;
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-size: 14px;
    font-weight: 700;
    color: #0626a9;
  }
  
  .new-step-button:hover {
    background-color: #fafbfc;
  }
  
  /* Step Detail Form */
  .step-form {
    display: none;
  }
  
  .step-form.active {
    display: block;
  }
  
  .form-actions {
    display: flex;
    justify-content: center;
    gap: 6px;
    margin-top: 65px;
  }
  
  .btn-cancel {
    flex-basis: 149px;
    flex-grow: 0;
    padding: 8px 16px;
    color: #6b7280;
    border: 1px solid #6b7280;
    background-color: #efefef;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }
  
  .btn-cancel:hover {
    background-color: #e5e7eb;
  }
  
  .btn-primary {
    flex-basis: 149px;
    flex-grow: 0;
    padding: 8px 16px;
    color: #fff;
    background-color: #0626a9;
    border: 1px solid #0626a9;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
  }
  
  .btn-primary:hover {
    background-color: #051d8a;
  }
  
  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  .alert {
    padding: 0.75rem 1rem;
    border-radius: 0.375rem;
    margin-bottom: 1.5rem;
  }
  
  .alert-danger {
    background-color: #f8d7da;
    color: #842029;
    border: 1px solid #f5c2c7;
  }
</style>

<script>
  // Step Generator JavaScript
  let currentStepIndex = 0;
  let steps = [];
  
  // Initialize first step
  document.addEventListener('DOMContentLoaded', function() {
    addStep();
    renderStepDropdown();
    showStepForm(0);
  });
  
  // Step Select Button Click
  document.getElementById('step-select-button').addEventListener('click', function() {
    const dropdown = document.getElementById('step-dropdown');
    const isOpen = dropdown.style.display !== 'none';
    dropdown.style.display = isOpen ? 'none' : 'block';
    this.classList.toggle('open');
  });
  
  // Add Step
  document.getElementById('add-step-button').addEventListener('click', function() {
    addStep();
    renderStepDropdown();
    showStepForm(steps.length - 1);
    document.getElementById('step-dropdown').style.display = 'none';
    document.getElementById('step-select-button').classList.remove('open');
  });
  
  function addStep() {
    const stepIndex = steps.length;
    steps.push({
      key: Date.now() + stepIndex,
      name: '',
      description: '',
      due_at: '',
      unlock_at: '',
      lock_at: '',
      points_possible: 0,
      submission_types: 'online_upload',
      allowed_extensions: [],
      peer_reviews: false
    });
    
    // Create step form
    createStepForm(stepIndex);
  }
  
  function createStepForm(index) {
    const container = document.getElementById('step-forms-container');
    const stepForm = document.createElement('div');
    stepForm.className = 'step-form';
    stepForm.id = `step-form-${index}`;
    stepForm.dataset.stepIndex = index;
    
    stepForm.innerHTML = `
      <div class="form-row">
        <div class="form-column-left">
          <label>Assignment Name</label>
        </div>
        <div class="form-column-right">
          <input type="text" 
                 name="project[assignments][${index}][name]" 
                 class="input-full" 
                 required 
                 maxlength="254"
                 placeholder="Assignment Name" />
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-column-left">
          <label>Description</label>
        </div>
        <div class="form-column-right">
          <textarea name="project[assignments][${index}][description]" 
                    class="input-full" 
                    rows="6"
                    placeholder="Assignment Description"></textarea>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-column-left">
          <label>Points</label>
        </div>
        <div class="form-column-right">
          <input type="number" 
                 name="project[assignments][${index}][points_possible]" 
                 class="input-full" 
                 min="0" 
                 step="0.1"
                 value="0" />
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-column-left">
          <label>Assign</label>
        </div>
        <div class="form-column-right">
          <div class="border-box">
            <div class="form-group">
              <label>Due Date</label>
              <input type="datetime-local" 
                     name="project[assignments][${index}][due_at]" 
                     class="input-full" 
                     required />
            </div>
            <div class="form-group">
              <label>Available from</label>
              <input type="datetime-local" 
                     name="project[assignments][${index}][unlock_at]" 
                     class="input-full" />
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label>Until</label>
              <input type="datetime-local" 
                     name="project[assignments][${index}][lock_at]" 
                     class="input-full" />
            </div>
          </div>
        </div>
      </div>
    `;
    
    container.appendChild(stepForm);
    
    // Add event listeners for date changes
    const dueAtInput = stepForm.querySelector('input[name*="[due_at]"]');
    const unlockAtInput = stepForm.querySelector('input[name*="[unlock_at]"]');
    const lockAtInput = stepForm.querySelector('input[name*="[lock_at]"]');
    
    [dueAtInput, unlockAtInput, lockAtInput].forEach(input => {
      input.addEventListener('change', function() {
        updateStepDate(index);
        renderStepDropdown();
      });
    });
  }
  
  function updateStepDate(index) {
    const form = document.getElementById(`step-form-${index}`);
    const unlockAt = form.querySelector('input[name*="[unlock_at]"]').value;
    const dueAt = form.querySelector('input[name*="[due_at]"]').value;
    const lockAt = form.querySelector('input[name*="[lock_at]"]').value;
    
    steps[index].unlock_at = unlockAt;
    steps[index].due_at = dueAt;
    steps[index].lock_at = lockAt;
  }
  
  function formatDateForPreview(dateString) {
    if (!dateString) return 'yy/mm/dd --:--';
    const date = new Date(dateString);
    const year = date.getFullYear().toString().slice(-2);
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}/${month}/${day} ${hours}:${minutes}`;
  }
  
  function renderStepDropdown() {
    const stepList = document.getElementById('step-list');
    stepList.innerHTML = '';
    
    steps.forEach((step, index) => {
      const stepItem = document.createElement('button');
      stepItem.type = 'button';
      stepItem.className = `step-item ${index === currentStepIndex ? 'selected' : ''}`;
      
      const unlockAt = formatDateForPreview(step.unlock_at);
      const dueAt = formatDateForPreview(step.due_at);
      const lockAt = formatDateForPreview(step.lock_at);
      
      stepItem.innerHTML = `
        <div class="step-item-content">
          <div class="step-item-info">
            ${index === currentStepIndex ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="#0626a9" stroke-width="2" fill="#0626a9"/><path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>' : ''}
            <span class="step-item-number">Step ${index + 1}</span>
          </div>
          <div class="step-item-date">
            <span>Start ${unlockAt} - Due ${dueAt}</span>
            <span>/ End ${lockAt}</span>
          </div>
        </div>
        ${steps.length > 1 ? '<button type="button" class="delete-step-btn" onclick="deleteStep(' + index + ')">üóëÔ∏è</button>' : ''}
      `;
      
      stepItem.addEventListener('click', function(e) {
        if (!e.target.closest('.delete-step-btn')) {
          selectStep(index);
        }
      });
      
      stepList.appendChild(stepItem);
    });
    
    // Update current step preview
    updateStepPreview();
  }
  
  function selectStep(index) {
    currentStepIndex = index;
    showStepForm(index);
    renderStepDropdown();
    document.getElementById('step-dropdown').style.display = 'none';
    document.getElementById('step-select-button').classList.remove('open');
  }
  
  function showStepForm(index) {
    document.querySelectorAll('.step-form').forEach(form => {
      form.classList.remove('active');
    });
    
    const form = document.getElementById(`step-form-${index}`);
    if (form) {
      form.classList.add('active');
      document.getElementById('step-detail-title').textContent = `Step ${index + 1}`;
      document.getElementById('current-step-number').textContent = `Step ${index + 1}`;
    }
  }
  
  function deleteStep(index) {
    if (steps.length <= 1) {
      alert('ÏµúÏÜå 1Í∞ú Ïù¥ÏÉÅÏùò StepÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
      return;
    }
    
    if (confirm('Ïù¥ StepÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
      steps.splice(index, 1);
      
      // Remove form
      const form = document.getElementById(`step-form-${index}`);
      if (form) form.remove();
      
      // Update form indices
      reindexSteps();
      
      // Adjust current step index
      if (currentStepIndex >= steps.length) {
        currentStepIndex = steps.length - 1;
      }
      
      renderStepDropdown();
      showStepForm(currentStepIndex);
    }
  }
  
  function reindexSteps() {
    // Reindex all step forms
    document.querySelectorAll('.step-form').forEach((form, newIndex) => {
      const oldIndex = parseInt(form.dataset.stepIndex);
      if (oldIndex !== newIndex) {
        form.id = `step-form-${newIndex}`;
        form.dataset.stepIndex = newIndex;
        
        // Update input names
        form.querySelectorAll('input, textarea, select').forEach(input => {
          const name = input.getAttribute('name');
          if (name) {
            input.setAttribute('name', name.replace(/\[assignments\]\[\d+\]/, `[assignments][${newIndex}]`));
          }
        });
      }
    });
  }
  
  function updateStepPreview() {
    const step = steps[currentStepIndex];
    const unlockAt = formatDateForPreview(step.unlock_at);
    const dueAt = formatDateForPreview(step.due_at);
    const lockAt = formatDateForPreview(step.lock_at);
    
    document.getElementById('step-date-preview').innerHTML = `
      <span>Start ${unlockAt} - Due ${dueAt}</span>
      <span>/ End ${lockAt}</span>
    `;
  }
  
  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    const wrapper = document.querySelector('.step-generator-wrapper');
    if (wrapper && !wrapper.contains(e.target)) {
      document.getElementById('step-dropdown').style.display = 'none';
      document.getElementById('step-select-button').classList.remove('open');
    }
  });
  
  // Form submission
  document.getElementById('project-form').addEventListener('submit', function(e) {
    if (steps.length === 0) {
      e.preventDefault();
      alert('ÏµúÏÜå 1Í∞ú Ïù¥ÏÉÅÏùò StepÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.');
      return false;
    }
  });
</script>
